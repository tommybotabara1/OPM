{% extends "home/doctorHeaderFooter.html" %}
{% load staticfiles%}

{% block content %}
<title> OPMS - Manage Device Recording </title>
    <style>


        .options{
            display:none;
        }

    </style>
    <script>
$(document).ready(function () {
    $(document).ajaxStart(function () {
        $("#loading").show();
    }).ajaxStop(function () {
        $("#loading").hide();
    });
});
        $(function() {
            $('#typeofManage').change(function(){
            $('.options').hide();
            $('#' + $(this).val()).show();
            });
        });

        $(document).ready(function(){
            $('.sidenav').sidenav();
        });


         $(document).ready(function(){
        $('.timepicker').timepicker();
      });

    </script>

                    <div class="col s12 white"><div class="col s12 m12 l12 center white">
<div id="loading" style="display: none">Loading</div>

            <div class="section"></div>

            <h3 id="greeting"><i class="material-icons" style="font-size: 40px;">ballot</i>&nbsp;&nbsp; Manage Device Recording</h3>
            <div class="section"></div>
            <div class="divider"></div>
            <div class="section"></div>

        </div>
        <div class="col s12 m12 l12 white center" style="padding: 0px 20px 0px 30px">
        {% if patient_device_list.count == 0 %}
            <h5><b>No current patients is using a device</b></h5>
        {% else %}
             <div class="row">
             <div class="col s4"></div>
                 <div class="col s4">
                        <h5>Choose Patient:</h5><br />
                          <select class="browser-default center col s12" id="patientID">
                              {% for patientdevice in patient_device_list %}
                                <option value="{{ patientdevice.patientdeviceid }}">{{ patientdevice.patient_patientid.userid.auth_user_id.first_name }} {{ patientdevice.patient_patientid.userid.auth_user_id.last_name }}</option>
                              {% endfor %}
                          </select>
                </div>
             <div class="col s4"></div>
             </div>
             <div class="row">
                <div class="col s3"></div>
                <div class="col s3">
                    <h5>Patient's Device Status:</h5><br />
                        <div id="patientDeviceStatus" class="teal lighten-5 z-depth-1" style="padding: 3.5%; border-radius: 10px;">
                    {% with patient_device_list.all|first as patientdevice %}
                      {% if patient_device_list.count == 0 %}
                      {% elif patientdevice.isrecording == 1 %}
                          <span class="teal-text"><b>Device is currently recording</b></span>
                      {% else %}
                          <span class="teal-text"><b>Device is not recording</b></span>
                      {% endif %}
                    {% endwith %}
                        </div>
                </div>
                <div class="col s3">
                    <h5>Duration per Recording:</h5><br />
                        <div id="patientDuration" class="teal lighten-5 z-depth-1" style="padding: 3.5%; border-radius: 10px;">
                    {% with patient_device_list.all|first as patientdevice %}
                          <span class="teal-text"><b>{{ patientdevice.recordingduration }} seconds</b></span>
                    {% endwith %}
                        </div>
                </div>
                <div class="col s3"></div>
            </div>
        {% endif %}
        <div class="col s12 m12 l12 white center" style="padding: 0px 20px 0px 30px">
                 <div class="row">
                    <div class="col s3"></div>
                    <div class="col s6">
                        <h5>Choose Action:</h5><br />
                        <select class="browser-default center col s12" id="typeofManage">
                            <option value="" disabled selected>Choose what to manage</option>
                            <option value="setinterval">Set Duration per Recording</option>
                            <option value="startstopresume">Start or Stop Recording</option>
                        </select>
                    </div>
                    <div class="col s3"></div>
                </div>
        </div>
        </div><br />

        <div class="col s12 m12 l12 white center" style="padding: 0px 20px 0px 30px">

            <!------------------------------------- SET INTERVAL PER RECORDDING ------------------------------------------->

            <div id="setinterval" class="options setinterval">
            <div class="divider"></div>
                <div class="row">
                    <h5>Set Duration per Recording</h5><br />
                    <div class="input-field col s3"></div>
                    <div class="input-field col s2">
                        <input id="hours" type="number" class="validate" min="0" max="23">
                        <label for="hours">Hours</label>
                    </div>
                    <div class="input-field col s2">
                        <input id="minutes" type="number" class="validate" min="0" max="59">
                        <label for="minutes">Minutes</label>
                    </div>
                    <div class="input-field col s2">
                        <input id="seconds" type="number" class="validate" min="0" max="59">
                        <label for="seconds">Seconds</label>
                    </div>
                    <div class="input-field col s3s"></div>
                </div><br />

                 <center>
                    <button class="btn-large" id="setDuration">Set Duration</button>
                </center>

            </div>


            <!------------------------------------- START / STOP / RESUME ------------------------------------------->

            <div id ="startstopresume" class="options startstopresume">
            <div class="divider"></div><br />

                <div id ="manageRecord" class="col s12 m12 l12  white" style="padding: 0px 20px 0px 30px">
                <center>
                    {% with patient_device_list.all|first as patientdevice %}
                      {% if patient_device_list.count == 0 %}
                          <button class="btn-large" id="stopresume" value=1 disabled>Stop Recording</button>
                      {% elif patientdevice.isrecording == 1 %}
                          <button class="btn-large" id="stopresume" value=1>Stop Recording</button>
                      {% else %}
                          <button class="btn-large" id="stopresume" value=0>Start Recording</button>
                      {% endif %}
                    {% endwith %}

                </center>

            </div>
            </div>
        </div>
        <br />
        <section></section>
        <section></section>
        </div>


<script>
      $("#stopresume").click(function() {
          var data = $(this).val();
          var deviceid = $("#patientID").val();

          if ($(this).attr('value') == '1') {
              $(this).html('Start Recording');
              $(this).val(0);
          }
          else{
              $(this).html('Stop Recording');
              $(this).val(1);
          }
        $.ajax({
        url: '{% url 'stop_recording' %}',
        data: {
          'deviceid': deviceid,
          'data': data,
        },
        dataType: 'json',
        success: function (data) {
            for(let i = 0; i < data.length; i++){
                alert(data[i].response);
            }
            location.reload();

        }

        });

      });

      $("#setDuration").click(function() {
          var hours = $("#hours").val();
          var minutes = $("#minutes").val();
          var seconds = $("#seconds").val();
          var deviceid = $("#patientID").val();

        $.ajax({
        url: '{% url 'set_recording_duration' %}',
        data: {
          'deviceid': deviceid,
          'hours': hours,
          'minutes': minutes,
          'seconds': seconds,
        },
        dataType: 'json',
        success: function (data) {
            for(let i = 0; i < data.length; i++){
                alert(data[i].response);
            }
            location.reload();

        }

        });

      });

      $("#startTime").change(function() {
          alert($("#startTime").val());

      });

      $("#patientID").change(function() {
          var patientdeviceid = $("#patientID").val();

          $.ajax({
            url: '{% url 'check_device_status' %}',
            data: {
              'patientdeviceid': patientdeviceid
            },
            dataType: 'json',
            success: function (data) {

                var patientDeviceStatus = "";
                var duration = "<span class=\"teal-text\"><b>"+data[0].duration+" seconds</b></span>";
                var button = "<center>";

                if(data[0].status == 0){
                    patientDeviceStatus += "<span class=\"teal-text\"><b>Device is not recording</b></span>";
                    button += "<button class=\"btn-large\" id=\"stopresume\" value=0>Start Recording</button>"
                }
                else{
                    patientDeviceStatus += "<span class=\"teal-text\"><b>Device is currently Recording</b></span>";
                    button += "<button class=\"btn-large\" id=\"stopresume\" value=1>Stop Recording</button>"
                }
                button += "</center>";

                $("#patientDeviceStatus").html(patientDeviceStatus);
                $("#manageRecord").html(button);
                $("#patientDuration").html(duration);
                }

            });

      });

</script>

{% endblock %}